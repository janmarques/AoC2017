using AoC2024;

var fullInput =
@"                                                                                                                                                             |                                           
 +-------------------------------+           +-------------+           +-+   +---------------------+     +-------+                       +-----------------------------------------+       +-----+       
 |                               |           |             |           | |   |                     |     |       |                       |                   |                     |       |     |       
 +-----+ +-----------------------------------|---+         |           | |   |     +---+           +-----|---------------+     +---------------+ +-----+ +---|---------------------|-------+ +---|-+ +-+ 
       | |                       |           |   |         |           | |   |     |   |                 |       |       |     |         |     | |     | |   |                     |         |   | | | | 
       +-|---+ +-----------------|---------------|---+     | +---------|-|-+ | +---|---|---------------------+   +---+   |     |         |     +-|-----|-|---|-----------------+   +---------|-------|-+ 
         |   | |                 |           |   |   |     | |         | | | | |   |   |                 |   |       |   |     |         |       |     | |   |                 |             |   | | |   
         |   | +-----------------|-------------------|-----|-|---------|-------|---+   |                 |   +-----------|-----|-----------+     |     | |   |             +---+           +-----|-|---+ 
         |   |                   |           |   |   |     | |         | | | | |       |                 |           |   |     |         | |     |     | |   |             |               | |   | | | | 
         |   +-------------------|---------------|-----------|-----------|-+ | +-------------------------|---+     +-|---------|---------|-|-----|-----------|-----------------------------------|-|-+ | 
         |                       |           |   |   |     | |         | |   |         |                 |   |     | |   |     |         | |     |     | |   |             |               | |   | |   | 
   +-+   | +---+ +-----------------------------------|---------------------+ +---------------------------|-----------|---|-----------------------------------|-------+     |       +---------+   | |   | 
   | |   | |   | |               |           |   |   |     | |         | | |           |                 |   |     | |   |     |         | |     |     | |   |       |     |       |       |     | |   | 
   | |   +-----------------------------------|---------------|-------------|-----------|-----------+     |   |     | |   |     |     +---|-|-----|-----------+       |   +---------------------+ | |   | 
   | |     |   | |               |           |   |   |     | |         | | |           |           |     |   |     | |   |     |     |   | |     |     | |           |   | |       |       |   | | |   | 
   | |     |   | |               | +-----------------|-----------------|-|-|-----------|-----------|-----|---|-----|-|---+     |   +-|---|-------|-------|---+   +---|---|-+ +-----|-----------|---|-+ | 
   | |     |   | |               | |         |   |   |     | |         | | |           |           |     |   |     | |         |   | |   | |     |     | |   |   |   |   |   |     |       |   | | | | | 
   | | +---|---|---------------------------+ |   |   |     | | +---------|-|---+       |           |     |   |     | |         |   | |   +-+     |     | +---|---|------P|-+ |     |       |   | +-+ | | 
   | | |   |   | |               | |       | |   |   |     | | |       | | |   |       |           |     |   |     | |         |   | |           |     |     |   |   |   | | |     |       |   |     | | 
   | | | +-|---|-|---------------|---------|---------|-+   | | |     +---|-----|-------|-----------|-----+   +---------------------|-------------|-----------|-------|-----+ |     |       |   |     | | 
   | | | | |   | |               | |       | |   |   | |   | | |     | | | |   |       |           |               | |         |   | |           |     |     |   |   |   |   |     |       |   |     | | 
   | | | | | +-------------------|---------|---------|-|-+ | | |     | | | |   |       |           |               | |         |   | |           |   +-|-----|---|-------------------------+ +-|---+ +-+ 
   | | | | | | | |               | |       | |   |   | | | | | |     | | | |   |       |           |               | |         |   | |           |   | |     |   |   |   |   |     |         | |   |     
   | | | | | | | |         +-----|---------------------|-+ | | |     | +-|-------------|-----+     |               | |         |   | |           |   | |     +-----------|---|---+ |         | |   |     
   | | | | | | | |         |     | |       | |   |   | |   | | |     |   | |   |       |     |     |               | |         |   | |           |   | Y         |   |   |   |   | |         | |   |     
   | | | | | | | |       +---+ +-----------|-|-------+ |   | | +-----|---|-----|-----------------------------+ +---------------|-----|---------------|-------+   |   |   |   |   | |         | |   |     
   | | | | | | | |       | | | | | |       | |   |     |   | |       |   | |   |       |     |     |         | |   | |         |   | |           |   | |     |   |   |   |   |   | |         | |   |     
   +-|-|-----|---|-------------|-|-|-------|-|---|-----|---|-------------|-|---+   +---------|-----|-----------------------+   +-----|-----------|---|-------+   +-----+ |   |   | |         | |   |     
     | | | | | | |       | | | | | |       | |   |     |   | |       |   | |       |   |     |     |         | |   | |     |       | |           |   | |             | | |   |   | |         | |   |     
     | | | | | | |       | | | | | |       | |   |     |   | |       |   | |       |   |     |     |         | |   | |     +-------|-------------|---+ +-------------|-|-|-+ |   | |         | |   |     
     | | | | | | |       | | | | | |       | |   |     |   | |       |   | |       |   |     |     |         | |   | |             | |           |                   | | | | |   | |         | |   |     
 +-----|-|-----|-|-------|-|-----------------|-------------|-|-----+ | +---+ +-------------------------------------|V----------------|-----------|---------------------------|---------------|-----+     
 |   | | | | | | |       | | | | | |       | |   |     |   | |     | | | |   |     |   |     |     |         | |   | |             | |           |                   | | | | |   | |         | |         
 |   | | | | | | |     +-----------|-+     | |   |     |   | |     | | | | +-|-----|---------|-----|-----------+   | |           +-|---------------------------------|-|-+ | |   | |       +-------+     
 |   | | | | | | |     | | | | | | | |     | |   |     |   | |     | | | | | |     |   |     |     |         |     | |           | | |           |                   | |   | |   | |       | | |   |     
 | +-|-|---|-|-|-------|---|---|-----|-----|-|---+   +-----|-|-----|-|-+ | | |     |   |     |     |         | +---+ |           | | |           |                   | |   | |   | |       | | |   |     
 | | | | | | | | |     | | | | | | | |     | |       | |   | |     | |   | | |     |   |     |     |         | |     |           | | |           |                   | |   | |   | |       | | |   |     
 | +-|-----|---|-|----Q----|-----+ | U +-----|-------|-----|-|-------|---|---+     |   |     |     |         | |     |     +-----|-|-----------------------------------|---------|---------|-----+ |     
 |   | | | | | | |     | | | | |   |   |   | |       | |   | |     | |   | |       |   |     |     |         | |     |     |     | | |           |                   | |   | |   | |       | | | | |     
 |   | | | | | | |     | | | | | +-------------------|-----|-|-----------|-|-----------------------|---------|-------------|---------------------|-----------+       | |   | |   | |       | | | | |     
 |   | | | | | | |     | | | | | | |   |   | |       | |   | |     | |   | |       |   |     |     |         | |     |     |     | | |           |           |       | |   | |   | |       | | | | |     
 |   | | | | +-|-------+ | | | +-|-----|---|-|---------|---|-|-----|-+   | |     +-|---|-----|-----------+   | |     |     |     | | |           |           |       | |   | | +-|-|-------+ | | | |     
 |   | | | |   | |       | | |   | |   |   | |       | |   | |     |     | |     | |   |     |     |     |   | |     |     |     | | |           |           |       | |   | | | | |         | | | |     
 |   | | | |   | |       | | |   | +---------|-------|-----|-----------------------|---------|---------+ |   | |     +-----|-----+ | |           |           |       | +-+ | | | | |         | | | |     
 |   | | | |   | |       | | |   |     |   | |       | |   | |     |     | |     | |   |     |     |   | |   | |           |       | |           |           |       |   | | | | | |         | | | |     
 |   | | | |   | |       +-|-|-------------|---+     | |   | |     |     | |     | |   |     |     |   | |   | |           |       | |           |           |       |   | | | | | |         | | | |     
 |   | | | |   | |         | |   |     |   | | |     | |   | |     |     | |     | |   |     |     |   | |   | |           |       | |           |           |       |   | | | | | |         | | | |     
 | +-|-|---|-------------------------+ |   | | |     | |   | |     |     | |     | | +-------|-----|---|-+   | |           |       | |           |           |       |   | | | | | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     | |   | |     |     | |     | | | |     |     |   |     | |           |       | |           |           |       |   | | | | | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     | |   | |     |     | |     | | | |     |     +-----------|-----------|-----------+         |   +-------------------+ | | | | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     | |   | |     |     | |     | | | |     |         |     | |           |       | | |         |   |       |       |     | | | | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     | +---|---+   |     | |     | | | |     |         |     | |           |       | | |         |   | +-----|-------------|---+ | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     |     | | |   |     | |     | | | |     |         |     | |           |       | | |         |   | |     |       |     | |   | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     |     | | |   |     | | +---|-|-|-|---------------------|-|-------------------|-+ |         |   | |     |       |     | |   | |         | | | |     
 | | | | | |   | |         | |   |   | |   | | |     |     | | |   |     | | |   | | | |     |         |     | |           |       |   |         |   | |     |       |     | |   | |         | | | |     
 | | | | | |   | |         | |   |   | |   | +-|-----|-------------|-----|-|-----------|-----|---+     +-----|---------------------|---|-------+ |   | |     |       |     | |   | |         | | | |     
 | | | | | |   | |         | |   |   | |   |   |     |     | | |   |     | | |   | | | |     |   |           | |           |       |   |       | |   | |     |       |     | |   | |         | | | |     
 | | | | | | +---+         | |   |   | |   |   |     |     | | |   |     +-|-----+ | | |     |   |           | |           |       |   |       | |   | |     |       |     | |   | |         | | | |     
 | | | | | | | |           | |   |   | |   |   |     |     | | |   |       | |     | | |     |   |           | |           |       |   |       | |   | |     |       |     | |   | |         | | | |     
 | | +-+ | | +-|-----------|---------|-|---|---|-------------------|-------|-----------|-----|---|-----------|-------------+       |   +-------|-|-----|-----|-------|-----------|-|-----------+ | |     
 | |     | |   |           | |   |   | |   |   |     |     | | |   |       | |     | | |     |   |           | |                   |           | |   | |     |       |     | |   | |         |   | |     
 | |     | |   |           | |   |   | | +-|---|-----|---------+   +-+     | |     +-|-----------|----B--------|-+                 |           | | +-+ |   +---+     |   +-|-|---+ |         |   | |     
 | |     | |   |           | |   |   | | | |   |     |     | |       |     | |       | |     |   |           | | |                 |           | | |   |   | | |     |   | | |     |         |   | |     
 | |     | |   +-----------|-----|---|-|-+ |   |     | +-----|-------------|-|---------|-----|---|-----------|-+ |                 |         +-|-+ |   |   | | |     |   | | |     |         |   | |     
 | |     | |               | |   |   | |   |   |     | |   | |       |     | |       | |     |   |           |   |                 |         | |   |   |   | | |     |   | | |     |         |   | |     
 | |     | |               | |   |   | |   |   | +---|-----|---------|---------------------------|-----------|---|-----------+     |         | |   |   |   | | |     |   | | |     |         |   | |     
 | |     | |               | |   |   | |   |   | |   | |   | |       |     | |       | |     |   |           |   |           |     |         | |   |   |   | | |     |   | | |     |         |   | |     
 | |     | |               | |   |   | |   +---|-----|---------------+     | |       | |     |   |           |   |         +-|-----|---------|-|-------|---|-|-|-----|---|---+     |         |   | |     
 | |     | |               | |   |   | |       | |   | |   | |             | |       | |     |   |           |   |         | |     |         | |   |   |   | | |     |   | |       |         |   | |     
 | |     | |               | |   |   | |       | |   | |   | |     +-------|-|-------|-----+ |   +-----------|---|---------|-------|---------|-----|-------|-|-|-----|---|-|-+     |         |   | |     
 | |     | |               | |   |   | |       | |   | |   | |     |       | |       | |   | |               |   |         | |     |         | |   |   |   | | |     |   | | |     |         |   | |     
 | |     | |               | |   |   | |       | |   | |   | |     |       | |       | |   | |               |   |         | |     +-----------|---|---------|-|-----|-+ | | |     |         |   | |     
 | |     | |               | |   |   | |       | |   | |   | |     |       | |       | |   | |               |   |         | |               | |   |   |   | | |     | | | | |     |         |   | |     
 | | +---|-----------------|-|-+ |   | |       | +---|-+ +---------|-------------------------|---+           |   |         | |               | |   |   |   | | |     | | | | |     |         |   | |     
 | | |   | |               | | | |   | |       |     |   | | |     |       | |       | |   | |   |           |   |         | |               | |   |   |   | | |     | | | | |     |         |   | |     
 | | |   | |               | +-+ | +-|---------|---------|-----------------------------|-----|---------------|-------------|-|-----------------+ +-|---|-------|---+ | | | | |     |         |   | |     
 | | |   | |               |     | | | |       |     |   | | |     |       | |       | |   | |   |           |   |         | |               |   | |   |   | | |   | | | | | |     |         |   | |     
 | | |   | |           +---|-----|---|-----+   | +---|-------|-----|-------|-|---------|---------------------|---|---------|---------------------------|---|-|-|---|---------------|---+ +-+ |   | |     
 | | |   | |           |   |     | | | |   |   | |   |   | | |     |       | |       | |   | |   |           |   |         | |               |   | |   |   | | |   | | | | | |     |   | | | |   | |     
 | | |   | |     +-----+   +-+   | | | |   |   | |   |   | | |     | +-----|-|-----+ | |   | | +-|-----------|---------------|-------------------------|-----|-|---+ | | | | |     |   | | | |   | |     
 | | |   | |     |           |   | | | |   |   | |   |   | | |     | |     | |     | | |   | | | |           |   |         | |               |   | |   |   | | |     | | | | |     |   | | | |   | |     
 | +-+   | |     |     +---------|---|-|---+   | |   |   | | |   +-|-------+ |     | | |   | | | |           |   |         | |         +-----+   | |   |   +-|-----------+ | |     |   | | | |   | |     
 |       | |     |     |     |   | | | |       | |   |   | | |   | | |       |     | | |   | | | |           |   |         | |         |         | |   |     | |     | |   | |     |   | | | |   | |     
 |       | |     |     |     |   | | | |       | |   |   | | |   | +---------------|-|-|---|-----|-----------------------------------------------|-|---|---------------|---|-----+ |   | | | |   | |     
 |       | |     |     |     |   | | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         | |         |         | |   |     | |     | |   | |   | |   | | | |   | |     
 |       | |     |     |     |   | | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         | +-------------------|-----|-------|---+ | |   | |   | |   | | | |   | |     
 |       | |     |     |     |   | | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |           |         | |   |     | |   | | |   | |   | |   | | | |   | |     
 |       | |     |     |     |   +-|-|---------|-----------------|-------------------|-|---|-----------------|---|---------|---------+ |         | |   |     | |   | | |   | |   | |   | | | |   | |     
 |       | |     |     |     |     | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     | |   | | |   | |   | |   | | | |   | |     
 |       | |     |     |     |     | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     | |   | | |   | |   | |   | | | |   | |     
 |       | |     |     |     |     | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     | |   | | |   | |   | |   | | | |   | |     
 |       | +-----|-----|-------+   | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     | +---|-|-|---|-------|-+ | | | |   | |     
 |       |       |     |     | |   | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     |     | | |   | |   | | | | | | |   | |     
 |       |   +---------|-----|-|---|---|-------|-|-----------|-----------------------|-----|-|---------------|-------------|-----------|---------|-------------------|-------|---|---|-|---|-|---|-----+ 
 |       |   |   |     |     | |   | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     |     | | |   | |   | | | | | | |   | |   | 
 |       |   |   |     |     | |   | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     |     | | |   | |   | | | | | | |   | |   | 
 |       |   |   |     |     | |   | | |       | |   |   | | |   |   |       |     | | |   | | | |           |   |         |         | |         | |   |     |     | | |   | |   | | | | | | |   | |   | 
 +-+     |   |   |     |     | |   | | |       | +-------+ | |   |   | +-----|-------+ |   | | | |           |   |         |         | +-----------|---|-----------|-|-+ +-+ |   | | | | | | |   | |   | 
   |     |   |   |     |     | |   | | |       |     |     | |   |   | |     |     |   |   | | | |           |   |         |         |           | |   |     |     | |   |   |   | | | | | | |   | |   | 
 +-----+ |   |   |     |     | |   | | |       |     |     | |   |   | |     |     |   |   | | | |           |   |         |         |           | |   |     |     | |   |   |   | | | | | | |   | |   | 
 | |   | |   |   |     |     | |   | | |       |     |     | |   |   | |     |     |   |   | | | |           |   |         |         |           | |   |     |     | |   |   |   | | | | | | |   | |   | 
 +-----|-|-------|-------------------|-|-------|-----------|-|---|---------------------|-----|---|-------------------------|---------|---+       | |   |     |     | |   |   |   | | | | +-----------+ | 
   |   | |   |   |     |     | |   | | |       |     |     | |   |   | |     |     |   |   | | | |           |   |         |         |   |       | |   |     |     | |   |   |   | | | |   | |   | | | | 
   |   | |   |   |     |     | |   | | |       |     |   +-|-|---------|-----------|---|---|---------------------|-------------------+   | +-+   | |   | +-----------|-+ |   |   | | | |   | |   | | | | 
   |   | |   |   |     |     | |   | | |       |     |   | | |   |   | |     |     |   |   | | | |           |   |         |             | | |   | |   | |   |     | | | |   |   | | | |   | |   | | | | 
 +-----|-----|-----------------|-----|---------|-------------|---------------------|---|-+ +-|-|-------------|-------------|-------------|-|-----+ |   | |   |     | | | |   |   | | | |   | |   | | | | 
 | |   | |   |   |     |     | |   | | |       |     |   | | |   |   | |     |     |   | |   | | |           |   |         |             | | |     |   | |   |     | | | |   |   | | | |   | |   | | | | 
 | +-------+ |   |     |     | |   | | |       |     |   | | |   |   | |     |     |   | +---|---|-----------|---|-------+ |             | | |     |   | |   |     | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |     | |   | | |       |     |   | | |   |   | |     |     |   |     | | |           |   |       | |             | | |     |   | |   |     | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |     | |   | | |       |     |   | | |   |   | |     |     |   |     | | |           |   |       +---------------|---|-----|-------------+ | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |     | |   | | |       |     |   | | |   |   | |     |     |   |     | | |           |   |         |             | | |     |   | |   |   | | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |   +-|-----|---|-------|---------|---|---|---|-------|-----|-----------|-------------------------------+         | | |     |   | |   |   | | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |   | | |   | | |       |     |   | | |   |   | |     |     |   |     | | |           |   |         |   |         | | |     |   | |   |   | | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |   | +---+ | | |       |     |   | | |   |   | |     |     |   |     | | |           |   |         |   |         | | |     |   | |   |   | | | | |   |   | | | |   | |   | | | | 
 |     | | | |   |     |   |   | | | | |       |     |   | | |   |   | |     |     |   |     | | |           |   |         |   |         | | |     |   | |   |   | | | | |   |   | | | |   | |   | | | | 
 |   +-|-|-------|-----+   |   | | | | |       |     |   | | |   +-----|---+ |     |   |     | | |           |   |         |   |         | +-|-----------|---|---|-|---|-|---------|-|-----|-|-+ | | | | 
 |   | | | | |   |         |   | | | | |       |     |   | | |       | |   | |     |   |     | | |           |   |         |   |         |   |     |   | |   |   | | | | |   |   | | | |   | | | | | | | 
 |   | | | | |   |         |   | | | | |       |     |   | | |       | |   | |     |   |     | | |           |   |         |   |         |   |     |   | |   |   | | | | |   |   | | | |   | | | | | | | 
 |   | | | | |   |         |   | | | | |       |     |   | | |       | |   | |     |   |     | | |           |   |         |   |         |   |     |   | |   |   | | | | |   |   | | | |   | | | | | | | 
 |   | | | | |   |         |   | | | | |       |     |   | | |       | +---|-|-+   |   |     | | |           |   |         |   | +-------|---|---------+ |   +---+ | | | | +-----|-+ | |   | | | | | | | 
 |   | | | | |   |         |   | | | | |       |     |   | | |       |     | | |   |   |     | | |           |   |         |   | |       |   |     |     |         | | | | | |   |   | |   | | | | | | | 
 |   | | | | |   |   +-----|---|-|-|-|---------------|-----|-|-------|-----|-|-|-------|-----|-----------------------------+   | |       |   |     |     |     +-----|-+ | | |   | +-+ |   | | | | | | | 
 |   | | | | |   |   |     |   | | | | |       |     |   | | |       |     | | |   |   |     | | |           |   |             | |       |   |     |     |     |   | |   | | |   | |   |   | | | | | | | 
 |   | | | | |   |   |     | +---|-|-|-------------------|-|-|-------|-------|---------|-------|-|---------------|-------------|-|---------------------+ |     |   | |   | | +-----|-------+ | | | | | | 
 |   | | | | |   |   |     | | | | | | |       |     |   | | |       |     | | |   |   |     | | |           |   |             | |       |   |     |   | |     |   | |   | |     | |   |     | | | | | | 
 |   | | | | |   +---------|-----|---|-|-------+     |   | | |   +-+ | +---|-|-+   +---------|-|-|-----------|---+             | |       |   |     |   | |     |   | |   | |     | |   |     | | | | | | 
 |   | | | | |       |     | | | | | | |             |   | | |   | | | |   | |         |     | | |           |                 | |       |   |     |   | |     |   | |   | |     | |   |     | | | | | | 
 |   | | | | |       |     | | | | | | |             |   | | |   | | | |   | |     +-------------|-------+   +-------------------+       |   |     |   +-------|---|-|-------+   | |   |     | | | | | | 
 |   | | | | |       |     | | | | | | |             |   | | |   | | | |   | |     |   |     | | |       |                     |         |   |     |     |     |   | |   | | |   | |   |     | | | | | | 
 |   | | | | |       |     | | | | | | |             |   | | |   | | | |   +-------|---------|-|-|-+     |                     |         |   |   +-------|---------|-----|---|---|---+ | +-+ | | | | | | 
 |   | | | | |       |     | | | | | | |             |   | | |   | | | |     |     |   |     | | | |     |                     |         |   |   | |     |     |   | |   | | |   | | | | | | | | | | | | 
 |   | | | | |       |     | | | | | | |             |   | | |   | | | |   +-------|---|-----|-|---|---------------------------|-------------|---|-|-----|-----|---|-------|-|---|---+ | | | | | | | | | 
 |   | | | | |       |     | | | | | F |             |   | | |   | | | |   | |     |   |     | | | |     |                     |         |   |   | |     |     |   | |   | | |   | |   | | | | | | | | | 
 |   | | | | |       |     | | | | | | |             |   +---+   | | | |   | +-----|---|---------------------------------------|---------|---+   +-|-----------|-----+   | +-+   | |   | | | | | | | | | 
 |   | | | | |       |     | | | | | | |             |     |     | | | |   |       |   |     A | | |     |                     |         |         |     |     |   |     |       | |   | | | | | | | | | 
 +---|-|-+ | |   +---------|---|---|---+             |     |     | | | |   |       |   |     | | | |     |   +-----------------------------------------+ |     |   |     |       | |   | | | | | | | | | 
     | |   | |   |   |     | | | | | |               |     |     | | | |   |       |   |     | | | |     |   |                 |         |         |   | |     |   |     |       | |   | | | | | | | | | 
     | | +-----------|-+   +-|-|-|-|-|---------------------|-------|-|-|-----------|---|-----|-|---------|---|-----------------|---------|---------------|-----|---|---------------|-----|-|-+ | | | | | 
     | | | | |   |   | |     | | | | |               |     |     | | | |   |       |   |     | | | |     |   |                 |         |         |   | |     |   |     |       | |   | | |   | | | | | 
 +-------|-|-|-------------+ | | | | |               |     |     | | | |   |       |   |     | | | |     |   |                 |         |         |   | |     |   |     |       | |   | | |   | | | | | 
 |   | | | | |   |   | |   | | | | | |               |     |     | | | |   |       |   |     | | | |     |   |                 |         |         |   | |     |   |     |       | |   | | |   | | | | | 
 |   | | | | |   |   | |   | | | | | |               |     |     | | | |   |       |   |     | | | +---------------+           |         |         |   | |     |   |     |       | |   | | |   | | | | | 
 |   | | | | |   |   | |   | | | | | |               |     |     | | | |   |       |   |     | | |       |   |     |           |         |         |   | |     |   |     |       | |   | | |   | | | | | 
 |   | | | | |   |   | |   | | | | | | +-------------|-----------------|-----------|---|-----|-|---------|-------------------------+     |         |   | |     |   |     |       | |   | | |   | | | | | 
 |   | | | | |   |   | |   | | | | | | |             |     |     | | | |   |       |   |     | | |       |   |     |           |   |     |         |   | |     |   |     |       | |   | | |   | | | | | 
 |   | | | | |   | +-|-+   | | | | | | |             |     |     | | | |   |       |   |     | | |       |   |     |           +---|-------------------|-|-----|---|-------------|-|-----|-----+ | | | | 
 |   | | | | |   | | |     | | | | | | |             |     |     | | | |   |       |   |     | | |       |   |     |               |     |         |   | |     |   |     |       | |   | | |     | | | | 
 |   | | | | | +-|---|-+   | | | | | | |             |     |     | | | |   |     +-+   |     | | |       |   |     |               |     +---------|-----|-----|---|-----|-------|-------|-|---+ | | | | 
 |   | | | | | | | | | |   | | | | | | |             |     |     | | | |   |     |     |     | | |       |   |     |               |               |   | |     |   |     |       | |   | | |   | | | | | 
 +---|---+ | | | | | | +-+ | | | | | | |             |     |     | | | |   |     |     |     | | |       |   |     |               |             +-|-----|---+ +-----------+     | |   | | |   | | | | | 
     | |   | | | | | |   | | | | | | | |             |     |     | | | |   |     |     |     | | |       |   |     |               |             | |   | |   |     |     | |     | |   | | |   | | | | | 
     +---+ +---|-+ | |   | | | | | | | |   +---------|-+   |     | | | |   |     |     |     | | |       |   |     |               |             | |   | |   |     |     | |     | |   | | |   | | | | | 
       | |   | |   | |   | | | | | | | |   |         | |   |     | | | |   |     |     |     | | |       |   |     |               |             | |   | |   |     |     | |     | |   | | |   | | | | | 
 +-------|---------|---------|-|---|-|-----|-----------|-----------|---|--W------------|---------------------|-----|-------------+ |             | |   | |   |     |     | |     | |   | | |   | | | | | 
 |     | |   | |   | |   | | | | | | | |   |         | |   |     | | | |   |     |     |     | | |       |   |     |             | |             | |   | |   |     |     | |     | |   | | |   | | | | | 
 |     | |   | +---|-|---|-----|-+ | | | +---+       | |   |     | | +-|---------------------|---|-------|-----------------------------------------|-----|---------|-----|-|-----|-----|---|-------|-+ | 
 |     | |   |     | |   | | | |   | | | | | |       | |   |     | |   |   |     |     |     | | |       |   |     |             | |             | |   | |   |     |     | |     | |   | | |   | | |   | 
 |     | | +-|-----|---+ | | +-----|---|---|-|---------|---|-----+ | +-+   |     |     |     | | |       |   |     |             | |             | |   | |   |     |     | +-----+ |   | | |   +-|-|-+ | 
 |     | | | |     | | | | |   |   | | | | | |       | |   |       | |     |     |     |     | | |       |   |     |             | |             | |   | |   |     |     |         |   | | |     | | | | 
 |     | | | |     | | | +---------|-+ | | | |       | |   |       | |     |     |     |     | | |       |   |     |             | |             | |   | |   |     |     |         |   | | |     | | | | 
 |     | | | |     | | |   |   |   |   | | | |       | |   |       | |     |     |     |     | | |       |   |     |             | |             | |   | |   |     |     |         |   | | |     | | | | 
 |     | | | |     | | |   |   |   |   | | | |       | |   |   +---|-+     |     |     |     | | |       |   |     |             | |       +-----|-----|-|---|-----------+         |   | | |     | | | | 
 |     | | | |     | | |   |   |   |   | | | |       | |   |   |   |       |     |     |     | | |       |   |     |             | |       |     | |   | |   |     |               |   | | |     | | | | 
 |     | +---|-----|-------|---|---|---|-|-|-+       | |   |   |   |   +---|-----|-----|-----------------|---|-----|-------------|---------------------|-----------|-------------------|---|-----+ | | | 
 |     |   | |     | | |   |   |   |   | | |         | |   |   |   |   |   |     |     |     | | |       |   |     |             | |       |     | |   | |   |     |               |   | | |       | | | 
 |     |   | |     | | |   |   |   |   | | |         | |   |   |   |   |   |     |     |     | | |       |   |     |             | |       |     | |   | |   |     |               |   | | |       | | | 
 |     |   | |     | | |   |   |   |   | | |         | |   |   |   |   |   |     |     |     | | |       |   |     |             | |       |     | |   | |   |     |               |   | | |       | | | 
 +-------------------|-|-+ |   |   |   | | |         | |   |   |   |   +---------|---------------|-------|---------|-------------+ +-------+     +-|-+ | |   |     |               |   +-|-|-------|-+ | 
       |   | |     | | | | |   |   |   | | |         | |   |   |   |       |     |     |     | | |       |   |     |                               | | | |   |     |               |     | |       |   | 
       |   | |   +-|-|-+ | |   |   |   | | |         | |   |   |   +-------|---------------------|-----------|-----|-------------------------------+ | | |   |     |               |     | |       +-+ | 
       |   | |   | | |   | |   |   |   | | |         | |   |   |           |     |     |     | | |       |   |     |                                 | | |   |     |               |     | |         | | 
       |   | |   +-|-|---------|-----+ | | |         | |   |   |         +-------------|-------|-------------|-----|-----------------------------------|-|---------|-----------------------|-+       | | 
       |   | |     | |   | |   |   | | | | |         | |   |   |         | |     |     |     | | |       |   |     |                                 | | |   |     |               |     | | |       | | 
       |   | |     | |   | |   |   | | | | |         | |   |   |         | |     |     |     | | |       |   |     |                                 | +-----|-----|-------------------+ | | |       | | 
       |   | |     | |   | |   |   | | | | |         | |   |   |         | |     |     |     | | |       |   |     |                                 |   |   |     |               |   | | | |       | | 
       |   +-------+ |   | |   +-----|-|-|-|---------------|---|---+   +---------------|-----+ +---------|---+     |                                 |   |   |     |               |   | | | |       | | 
       |     |       |   | |       | | | | |         | |   |   |   |   | | |     |     |         |       |         |                                 |   |   |     |               |   | | | |       | | 
       |     |       |   | |       | | | +-+         | |   |   +---+ +-----|-----------|---------|-----------------|-------------------------------+ |   |   |     |               |   | | | |       | | 
       |     |       |   | |       | | |             | |   |         | | | |     |     |         |       |         |                               | |   |   |     |               |   | | | |       | | 
       |     |       |   | |       | | |             | |   |         | | | |     |     |         |       |         |                               | |   |   |     |               | +-|-|-------+   | | 
       |     |       |   | |       | | |             | |   |         | | | |     |     |         |       |         |                               | |   |   |     |               | | | | | |   |   | | 
       |     |       |   | |       | | |             | |   +-----------|-|-------|-----|---------+       |         |                 +-------------|-----|-------------------------|-|-|-+ | |   |   +-+ 
       |     |       |   | |       | | |             | |             | | | |     |     |                 |         |                 |             | |   |   |     |               | | |   | |   |       
 +-----+ +---+ +-------------------|-----------------+ |           +-|-+ +-------------------------------+         |                 |         +-------------------|---------------|---+   | |   |       
 |       |     |     |   | |       | | |               |           | |     |     |     |                           |                 |         |   | |   |   |     |               | |     | |   |       
 |       |     +---------|-|-----------|-----------------------------------+     +-----|-----------------------------------------------------------|-|-------------|-----------------|-+   | |   | +---+ 
 |       |           |   | |       | | |               |           | |                 |                           |                 |         |   | |   |   |     |               | | |   | |   | |   | 
 |       |     +-----|---|-------------|-----------------------------------------------|---------------------------|-----------------|---------|---|-+   |   |     +-----------------|-+   | |   | |   | 
 |       |     |     |   | |       | | |               |           | |                 |                           |                 |         |   |     |   |                     | |     | |   | |   | 
 +-----------+ +-----+   | |       | +-+   +-----------|-----------|-----------------------------------------------+                 |         +---+     |   +-----------------------------|-+   | |   | 
         |   |           | |       |       |           |           | |                 |                                             |                   |                         | |     |     | |   | 
 +-------|---|-----------+ |       |       |           |           | |                 +-------------------------+                   +-------------------+ +-+                     | |     |     | |   | 
 |       |   |             |       |       |           |           | |                                           |                                         | |                     | |     |     | |   | 
 |       |   |             |       |       |           +---------------------------------------------------------------------------------------------------+ |                     | |     |     | |   | 
 |       |   |             |       |       |                       | |                                           |                                           |                     | |     |     | |   | 
 +-------|---+             |       +--------------------------------T|-------------------------------------------|-----------------------------------------------------------------|-|-----|-------+   | 
         |                 |               |                       | |                                           |                                           |                     | |     |     |     | 
         +-----------------------------------------------------------|---------------------------------------------------------------------------------------|-------------------+ +-+     +-----+     | 
                           |               |                       | |                                           |                                           |                   |                     | 
                           +---------------+                       +-+                                           +-------------------------------------------+                   +---------------------+ 
                                                                                                                                                                                                         ";

var smallInput =
@"     |          
     |  +--+    
     A  |  C    
 F---|----E|--+ 
     |  |  |  D 
     +B-+  +--+ ";

var smallest = "";

var input = smallInput;
input = fullInput;
//input = smallest;
var timer = System.Diagnostics.Stopwatch.StartNew();

var result = "";

var grid = Utils.ParseCoordGrid(input).ToList();
var pos = grid.Single(x => x.y == 0 && x.c == '|');
var dir = 'S';

var visited = new HashSet<(int, int, char)>();
while (true)
{
    var d = Utils.Directions.Single(x => x.icon == dir);

    visited.Add(pos);
    if (pos.c == '+')
    {
        try
        {

        var xx = Utils.Directions.Where(x => x.icon != Utils.InverseDirection(dir)).Select(d => (d.icon, grid.SingleOrDefault(g => g.x == pos.x + d.x && g.y == pos.y + d.y && g.c != ' '))).Where(x => x.Item2 != default).ToList();
        var next = Utils.Directions.Where(x => x.icon != Utils.InverseDirection(dir)/* && x.icon != dir*/).Select(d => (d.icon, grid.SingleOrDefault(g => g.x == pos.x + d.x && g.y == pos.y + d.y && g.c != ' '))).Where(x => x.Item2 != default).Single();
        dir = next.icon;
        pos = next.Item2;
        } catch (Exception)
        {

            Utils.PrintGrid(visited, x => x.Item1, x => x.Item2, x => x.Item3.ToString(), 201, 201, nullPrint: (_, _) => " ");
        }
    }
    else
    {
        var next = grid.SingleOrDefault(g => g.x == pos.x + d.x && g.y == pos.y + d.y && g.c != ' ');
        if(pos.c == 'U')
        {

        }
        if (char.IsLetter(pos.c))
        {
            result += pos.c;
        }
        if (next == default) { break; }
        pos = next;
    }

   

}

timer.Stop();
Console.WriteLine(result); // VTWBPYAQFUQAYPBWTV wrong
Console.WriteLine(timer.ElapsedMilliseconds + "ms");
Console.ReadLine();